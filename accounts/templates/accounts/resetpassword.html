{% extends 'store/base.html' %}
{% load static %}
{% block title %}Eshop | Change Password{% endblock %}
{% block content %}

<style>
    .invalid {
        color: red;
    }

    .text-success {
        color: green;
    }
</style>

<div class="login_register_wrap section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-xl-6 col-md-10">
                <div class="login_wrap">
                    <div class="padding_eight_all bg-white">
                        <div class="heading_s1">
                            <h3>Set New Password</h3>
                        </div>
                        <form method="POST" id="password-form">
                            {% csrf_token %}
                            <div class="form-group mb-3">
                                <input class="form-control" required type="password" name="password" id="password"
                                    placeholder="Enter Password">
                                <div class="invalid-feedback" id="password-error"></div>
                            </div>

                            <div class="form-group mb-3">
                                <input class="form-control" required type="password" name="confirm_password"
                                    id="confirm_password" placeholder="Confirm Password">
                                <div class="invalid-feedback" id="confirm-error"></div>
                            </div>

                            <div id="password-contain" class="p-3 bg-light mb-2 rounded">
                                <h5 class="fs-13">Password must contain:</h5>
                                <p id="pass-length" class="invalid fs-12 mb-2">Minimum <b>8 characters</b></p>
                                <p id="pass-lower" class="invalid fs-12 mb-2">At least <b>lowercase</b> letter (a-z)</p>
                                <p id="pass-upper" class="invalid fs-12 mb-2">At least <b>uppercase</b> letter (A-Z)</p>
                                <p id="pass-number" class="invalid fs-12 mb-2">At least <b>number</b> (0-9)</p>
                                <p id="pass-special" class="invalid fs-12 mb-0">At least one <b>special
                                        character</b>(!@#$...)</p>
                                <p id="pass-match" class="invalid fs-12 mb-0">Passwords must <b>match</b></p>
                            </div>

                            <div class="form-group mb-3">
                                <button type="submit" id="password-btn" class="btn btn-fill-out btn-block">
                                    <span id="password-spinner"
                                        class="spinner-border spinner-border-sm text-white d-none" role="status"
                                        aria-hidden="true"></span>
                                    <span id="password-text">Save Password</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const passwordInput = document.getElementById("password");
        const confirmInput = document.getElementById("confirm_password");
        const container = document.getElementById("password-contain");
        const passLength = document.getElementById("pass-length");
        const passLower = document.getElementById("pass-lower");
        const passUpper = document.getElementById("pass-upper");
        const passNumber = document.getElementById("pass-number");
        const passSpecial = document.getElementById("pass-special");
        const passMatch = document.getElementById("pass-match");
        const form = document.getElementById("password-form");
        const passwordBtn = document.getElementById("password-btn");
        const passwordSpinner = document.getElementById("password-spinner");
        const passwordText = document.getElementById("password-text");

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function updateClass(element, isValid) {
            if (isValid) {
                element.classList.remove("invalid");
                element.classList.add("text-success");
            } else {
                element.classList.add("invalid");
                element.classList.remove("text-success");
            }
        }

        function validatePassword() {
            const val = passwordInput.value;
            const hasLength = val.length >= 8;
            const hasLowercase = /[a-z]/.test(val);
            const hasUppercase = /[A-Z]/.test(val);
            const hasNumber = /\d/.test(val);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(val);
            const isMatch = val === confirmInput.value && val !== "";

            updateClass(passLength, hasLength);
            updateClass(passLower, hasLowercase);
            updateClass(passUpper, hasUppercase);
            updateClass(passNumber, hasNumber);
            updateClass(passSpecial, hasSpecial);
            updateClass(passMatch, isMatch);

            return hasLength && hasLowercase && hasUppercase && hasNumber && hasSpecial && isMatch;
        }

        passwordInput.addEventListener("input", validatePassword);
        confirmInput.addEventListener("input", validatePassword);

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            if (!validatePassword()) {
                Swal.fire({
                    icon: "warning",
                    title: "Password Validation",
                    text: "Please meet all password requirements.",
                });
                return;
            }

            passwordSpinner.classList.remove('d-none');
            passwordText.textContent = 'Saving...';
            passwordBtn.disabled = true;

            const formData = $(this).serialize();

            $.ajax({
                type: 'POST',
                url: '{% url "resetpassword" %}',
                data: formData,
                headers: { 'X-CSRFToken': csrftoken },
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: response.message,
                            showConfirmButton: false,
                            timer: 3000,
                            willClose: () => {
                                window.location.href = response.redirect_url;
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed',
                            text: response.message || 'Something went wrong.',
                        });
                    }
                    passwordSpinner.classList.add('d-none');
                    passwordText.textContent = 'Save Password';
                    passwordBtn.disabled = false;
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred. Please try again later.',
                    });
                    passwordSpinner.classList.add('d-none');
                    passwordText.textContent = 'Save Password';
                    passwordBtn.disabled = false;
                }
            });
        });
    });
</script>
{% endblock %}