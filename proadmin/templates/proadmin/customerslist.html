{% extends 'proadmin/base.html' %}
{% load static %}
{% block title %} Eshop-Admin | Customer's {% endblock %}
{% block content %}
<div class="page-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
          <h4 class="mb-sm-0">Customers</h4>

          <div class="page-title-right">
            <ol class="breadcrumb m-0">
              <li class="breadcrumb-item"><a href="javascript: void(0);">Customers</a></li>
              <li class="breadcrumb-item active">All Customers</li>
            </ol>
          </div>

        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12">
        <div class="card" id="customerList">
          <div class="card-header border-bottom-dashed">
            <div class="row g-4 align-items-center">
              <div class="col-sm">
                <div>
                  <h5 class="card-title mb-0">Customer List</h5>
                </div>
              </div>
              <div class="col-sm-auto">
                <div class="d-flex flex-wrap align-items-start gap-2">
                  <button class="btn btn-soft-danger" id="remove-actions" onClick="deleteMultiple()"><i
                      class="ri-delete-bin-2-line"></i></button>
                  <button type="button" class="btn btn-success add-btn" data-bs-toggle="modal" id="create-btn"
                    data-bs-target="#showModal"><i class="ri-add-line align-bottom me-1"></i> Add
                    Customer</button>
                  
                </div>
              </div>
            </div>
          </div>
          <div class="card-body border-bottom-dashed border-bottom">
            <form>
              <div class="row g-3">
                <div class="col-xl-6">
                  <div class="search-box">
                    <input type="text" class="form-control search"
                      placeholder="Search for customer, email, phone, status or something...">
                    <i class="ri-search-line search-icon"></i>
                  </div>
                </div>
                <div class="col-xl-6">
                  <div class="row g-3">
                    <div class="col-sm-4">
                      <div class="">
                        <input type="text" class="form-control" id="datepicker-range" data-provider="flatpickr"
                          data-date-format="d M, Y" data-range-date="true" placeholder="Select date">
                      </div>
                    </div>
                    <div class="col-sm-4">
                      <div>
                        <select class="form-control" data-plugin="choices" data-choices data-choices-search-false
                          name="choices-single-default" id="idStatus">
                          <option value="">Status</option>
                          <option value="all" selected>All</option>
                          <option value="Active">Active</option>
                          <option value="Block">Block</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-sm-4">
                      <div>
                        <button type="button" class="btn btn-primary w-100" onclick="SearchData();"> <i
                            class="ri-equalizer-fill me-2 align-bottom"></i>Filters</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="card-body">
            <div>
              <div class="table-responsive table-card mb-1">
                <table class="table align-middle" id="customerTable">
                  <thead class="table-light text-muted">
                    <tr>
                      <th scope="col" style="width: 50px;">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="checkAll" value="option">
                        </div>
                      </th>
                      <th class="sort" data-sort="customer_name">Customer</th>
                      <th class="sort" data-sort="email">Email</th>
                      <th class="sort" data-sort="phone">Phone</th>
                      <th class="sort" data-sort="date">Joining Date</th>
                      <th class="sort" data-sort="status">Status</th>
                      <th class="sort" data-sort="action">Action</th>
                    </tr>
                  </thead>
                  <tbody class="list form-check-all">
                    {% if customers %}
                    {% for customer in customers %}
                    <tr>
                      <th scope="row">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="chk_child" value="{{ customer.id }}">
                        </div>
                      </th>
                      <td class="customer_name">{{ customer.firstname }} {{ customer.lastname }}</td>
                      <td class="email">{{ customer.email }}</td>
                      <td class="phone">{{ customer.phone_number|default:"N/A" }}</td>
                      <td class="date">{{ customer.date_joined|date:"d M, Y" }}</td>
                      <td class="status">
                        <span
                          class="badge {% if customer.is_active %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %} text-uppercase">
                          {% if customer.is_active %}Active{% else %}Block{% endif %}
                        </span>
                      </td>
                      <td>
                        <ul class="list-inline hstack gap-2 mb-0">
                          <li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover"
                            data-bs-placement="top" title="View Full Detail">
                            <a href="{% url 'customer_detail' customer.id %}" class="text-info d-inline-block">
                              <i class="ri-eye-fill fs-16"></i>
                            </a>
                          </li>
                          <li class="list-inline-item edit" data-bs-toggle="tooltip" data-bs-trigger="hover"
                              data-bs-placement="top" title="Edit">
                              <a href="#" data-bs-toggle="modal" data-bs-target="#editModal"
                                  class="text-primary d-inline-block edit-item-btn" data-user-id="{{ customer.id }}">
                                  <i class="ri-pencil-fill fs-16"></i>
                              </a>
                          </li>
                          <li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover"
                              data-bs-placement="top" title="Remove">
                              <a class="text-danger d-inline-block remove-item-btn" data-bs-toggle="modal"
                                  href="#deleteRecordModal" data-user-id="{{ customer.id }}">
                                  <i class="ri-delete-bin-5-fill fs-16"></i>
                              </a>
                          </li>
                        </ul>
                      </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                      <td colspan="7" class="text-center">
                        <div class="noresult">
                          <div class="text-center">
                            <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop"
                              colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px"></lord-icon>
                            <h5 class="mt-2">Sorry! No Customers Found</h5>
                          </div>
                        </div>
                      </td>
                    </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
              <div class="d-flex justify-content-end">
                <div class="pagination-wrap hstack gap-2">
                  <a class="page-item pagination-prev disabled" href="#">
                    Previous
                  </a>
                  <ul class="pagination listjs-pagination mb-0"></ul>
                  <a class="page-item pagination-next" href="#">
                    Next
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Add Customer Modal -->
<div class="modal fade" id="showModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light p-3">
        <h5 class="modal-title" id="exampleModalLabel">Add Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close-modal"></button>
      </div>
      <form class="tablelist-form" method="post" action="{% url 'add_customer' %}">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="id-field" />
          <div class="mb-3" id="modal-id" style="display: none;">
            <label for="id-field1" class="form-label">ID</label>
            <input type="text" id="id-field1" class="form-control" placeholder="ID" readonly />
          </div>

          <div class="mb-3">
            <label for="username-field" class="form-label">Username</label>
            <input type="text" id="username-field" class="form-control" name="username" placeholder="Enter username" required />
            <div class="invalid-feedback">Please enter a username.</div>
          </div>

          <div class="mb-3">
            <label for="firstname-field" class="form-label">First Name</label>
            <input type="text" id="firstname-field" class="form-control" name="firstname" placeholder="Enter first name" />
          </div>

          <div class="mb-3">
            <label for="lastname-field" class="form-label">Last Name</label>
            <input type="text" id="lastname-field" class="form-control" name="lastname" placeholder="Enter last name" />
          </div>

          <div class="mb-3">
            <label for="email-field" class="form-label">Email</label>
            <input type="email" id="email-field" class="form-control" name="email" placeholder="Enter email" required />
            <div class="invalid-feedback">Please enter an email.</div>
          </div>

          <div class="mb-3">
            <label for="phone-field" class="form-label">Phone</label>
            <input type="text" id="phone-field" class="form-control" name="phone_number" placeholder="Enter phone no." />
          </div>
          
          <div class="mb-3">
            <label for="address-field" class="form-label">Address</label>
            <textarea id="address-field" class="form-control" name="address" placeholder="Enter address"></textarea>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="city-field" class="form-label">City</label>
                <input type="text" id="city-field" class="form-control" name="city" placeholder="Enter city" />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="country-field" class="form-label">Country</label>
                <input type="text" id="country-field" class="form-control" name="country" placeholder="Enter country" />
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="postalcode-field" class="form-label">Postal Code</label>
            <input type="text" id="postalcode-field" class="form-control" name="postal_code" placeholder="Enter postal code" />
          </div>

          <div class="mb-3">
            <label for="password-field" class="form-label">Password</label>
            <input type="password" id="password-field" class="form-control" name="password" placeholder="Enter password" required />
            <div class="invalid-feedback">Please enter a password.</div>
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="status-field" name="is_active" checked>
              <label class="form-check-label" for="status-field">Active Account</label>
            </div>
          </div>
          
        </div>
        <div class="modal-footer">
          <div class="hstack gap-2 justify-content-end">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-success" id="add-btn">Add Customer</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Edit Customer Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light p-3">
        <h5 class="modal-title" id="editModalLabel">Edit Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form class="tablelist-form" method="post" action="" id="edit-form">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="edit-id" name="user_id" />
          
          <div class="mb-3">
            <label for="edit-username" class="form-label">Username</label>
            <input type="text" id="edit-username" class="form-control" name="username" placeholder="Enter username" required />
            <div class="invalid-feedback">Please enter a username.</div>
          </div>

          <div class="mb-3">
            <label for="edit-firstname" class="form-label">First Name</label>
            <input type="text" id="edit-firstname" class="form-control" name="firstname" placeholder="Enter first name" />
          </div>

          <div class="mb-3">
            <label for="edit-lastname" class="form-label">Last Name</label>
            <input type="text" id="edit-lastname" class="form-control" name="lastname" placeholder="Enter last name" />
          </div>

          <div class="mb-3">
            <label for="edit-email" class="form-label">Email</label>
            <input type="email" id="edit-email" class="form-control" name="email" placeholder="Enter email" required />
            <div class="invalid-feedback">Please enter an email.</div>
          </div>

          <div class="mb-3">
            <label for="edit-phone" class="form-label">Phone</label>
            <input type="text" id="edit-phone" class="form-control" name="phone_number" placeholder="Enter phone no." />
          </div>
          
          <div class="mb-3">
            <label for="edit-address" class="form-label">Address</label>
            <textarea id="edit-address" class="form-control" name="address" placeholder="Enter address"></textarea>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="edit-city" class="form-label">City</label>
                <input type="text" id="edit-city" class="form-control" name="city" placeholder="Enter city" />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="edit-country" class="form-label">Country</label>
                <input type="text" id="edit-country" class="form-control" name="country" placeholder="Enter country" />
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="edit-postalcode" class="form-label">Postal Code</label>
            <input type="text" id="edit-postalcode" class="form-control" name="postal_code" placeholder="Enter postal code" />
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="edit-status" name="is_active">
              <label class="form-check-label" for="edit-status">Active Account</label>
            </div>
          </div>
          
        </div>
        <div class="modal-footer">
          <div class="hstack gap-2 justify-content-end">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-success" id="edit-btn">Update Customer</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Delete Modal -->
<div class="modal fade zoomIn" id="deleteRecordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="btn-close"></button>
            </div>
            <div class="modal-body">
                <div class="mt-2 text-center">
                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop"
                        colors="primary:#f7b84b,secondary:#f06548" style="width:100px;height:100px">
                    </lord-icon>
                    <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                        <h4>Are you sure ?</h4>
                        <p class="text-muted mx-4 mb-0">Are you sure you want to remove this customer?</p>
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                    <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn w-sm btn-danger" id="delete-record">Yes, Delete It!</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Function to handle edit button click
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to all edit buttons
    const editButtons = document.querySelectorAll('.edit-item-btn');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            loadCustomerData(userId);
        });
    });
    
    // Set up the edit form action
    const editForm = document.getElementById('edit-form');
    editForm.addEventListener('submit', function(e) {
        const userId = document.getElementById('edit-id').value;
        this.action = "{% url 'edit_customer' 0 %}".replace('0', userId);
    });
});

// Function to load customer data via AJAX
function loadCustomerData(userId) {
    fetch("{% url 'get_customer_data' 0 %}".replace('0', userId))
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Populate the edit form with customer data
            document.getElementById('edit-id').value = data.id;
            document.getElementById('edit-username').value = data.username || '';
            document.getElementById('edit-firstname').value = data.firstname || '';
            document.getElementById('edit-lastname').value = data.lastname || '';
            document.getElementById('edit-email').value = data.email || '';
            document.getElementById('edit-phone').value = data.phone_number || '';
            document.getElementById('edit-address').value = data.address || '';
            document.getElementById('edit-city').value = data.city || '';
            document.getElementById('edit-country').value = data.country || '';
            document.getElementById('edit-postalcode').value = data.postal_code || '';
            document.getElementById('edit-status').checked = data.is_active;
            
            // Show the edit modal
            var editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading customer data: ' + error.message);
        });
}
</script>
<script>
// Delete functionality
document.addEventListener('DOMContentLoaded', function() {
    let deleteUserId = null;
    
    // Set up delete button click
    const deleteButtons = document.querySelectorAll('.remove-item-btn');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            deleteUserId = this.getAttribute('data-user-id');
        });
    });
    
    // Handle delete confirmation
    document.getElementById('delete-record').addEventListener('click', function() {
        if (deleteUserId) {
            deleteCustomer(deleteUserId);
        }
    });
    
    // Reset deleteUserId when modal is closed
    document.getElementById('deleteRecordModal').addEventListener('hidden.bs.modal', function() {
        deleteUserId = null;
    });
});

// Function to delete customer via AJAX
function deleteCustomer(userId) {
    fetch("{% url 'delete_customer' 0 %}".replace('0', userId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close the modal
            var deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteRecordModal'));
            deleteModal.hide();
            
            // Show success message
            alert('Customer deleted successfully!');
            
            // Reload the page to see changes
            location.reload();
        } else {
            alert('Error deleting customer: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting customer: ' + error.message);
    });
}
</script>
{% endblock %}